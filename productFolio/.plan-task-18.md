# Task #18 Plan: Feature flags hook + conditional nav in Layout

## Summary
Create `useFeatureFlags` React Query hook and update Layout.tsx to conditionally show/hide navigation items based on feature flag state.

## Files to Create

### 1. `packages/frontend/src/hooks/useFeatureFlags.ts` (NEW)

**FeatureFlag type:**
```ts
interface FeatureFlag {
  id: string;
  key: string;
  enabled: boolean;
  description: string | null;
  metadata: Record<string, unknown> | null;
  createdAt: string;
  updatedAt: string;
}
```

**Query key factory** (following usePortfolioAreas pattern):
```ts
export const featureFlagKeys = {
  all: ['featureFlags'] as const,
  list: () => [...featureFlagKeys.all, 'list'] as const,
};
```

**Hooks:**
- `useFeatureFlags()` — `useQuery` calling `GET /api/feature-flags`, staleTime: 5 min (flags rarely change), returns all flags
- `useFeatureFlag(key: string)` — convenience hook that calls `useFeatureFlags()` and returns `{ enabled: boolean, isLoading: boolean }` for a single flag key. Defaults to `false` when loading or flag not found (safe default = hidden).
- `useUpdateFeatureFlag()` — `useMutation` calling `PUT /api/feature-flags/:key` with `{ enabled }` body. Invalidates featureFlagKeys.list(). (Needed for Task #19 FF Admin page but cheap to include now.)

## Files to Modify

### 2. `packages/frontend/src/hooks/index.ts` — Add exports
```ts
// Feature flag hooks
export {
  useFeatureFlags,
  useFeatureFlag,
  useUpdateFeatureFlag,
  featureFlagKeys,
} from './useFeatureFlags';
```

### 3. `packages/frontend/src/components/Layout.tsx` — Conditional nav

**Approach:** Split the `navigation` array into two parts:
- `coreNavigation` — always-visible items (Intake, Initiatives, Capacity, Scenarios, Reports, Delivery, Approvals, Org Structure, Portfolio Areas, Jira Settings)
- Inside the component, call `useFeatureFlag()` for each gated page and filter/append conditional items

**Gated nav items:**
| Nav Item | Flag Key | Route | Icon |
|----------|----------|-------|------|
| Job Profiles | `job_profiles` | `/admin/job-profiles` | New icon (BriefcaseIcon variant) |
| Org Capacity | `org_capacity_view` | `/org-capacity` | UsersIcon variant |
| Flow Forecast | `flow_forecast_v1` | `/forecast` | ChartBarIcon variant |

**Implementation detail:**
- Add a `useNavigation()` block inside the `Layout` component that builds the final nav array by starting with `coreNavigation` and conditionally inserting gated items at appropriate positions
- Feature Flags Admin page (`/admin/feature-flags`) is only visible to ADMIN role users (no flag needed — it's the tool for managing flags). Check `useCurrentUser()` role.

### 4. `packages/frontend/src/components/Layout.tsx` — Breadcrumb map
Add entries for new paths:
```ts
'job-profiles': 'Job Profiles',
'org-capacity': 'Org Capacity',
'forecast': 'Flow Forecast',
'feature-flags': 'Feature Flags',
```

## Design Decisions

1. **Safe defaults:** `useFeatureFlag(key)` returns `false` while loading — new pages stay hidden until flags are confirmed enabled. No flash of content.
2. **staleTime: 5 minutes** for flags query — flags change rarely, no need to refetch on every navigation.
3. **FF Admin nav visibility:** Based on user role (ADMIN only), not on a feature flag (chicken-and-egg: need the admin page to enable other flags).
4. **No router changes yet** — Routes will be added in Tasks 19-22 when pages are created. The nav links will just 404 until the routes exist, which is fine since flags are disabled by default.

## Risks
- Backend API shape assumption: `GET /api/feature-flags` returns `FeatureFlag[]` (not paginated). If it returns `{ data: FeatureFlag[], pagination: {...} }`, I'll adjust the hook.
- Will verify the actual API response shape once Task #6 is complete before implementing.
