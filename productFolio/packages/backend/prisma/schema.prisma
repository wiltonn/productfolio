generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Enums
// ============================================================================

enum InitiativeStatus {
  PROPOSED
  SCOPING
  RESOURCING
  IN_EXECUTION
  COMPLETE
  ON_HOLD
  CANCELLED
}

enum DeliveryHealth {
  ON_TRACK
  AT_RISK
  DELAYED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN
}

enum UserRole {
  ADMIN
  PRODUCT_OWNER
  BUSINESS_OWNER
  RESOURCE_MANAGER
  VIEWER
}

enum PeriodType {
  WEEK
  MONTH
  QUARTER
}

enum ScenarioStatus {
  DRAFT
  REVIEW
  APPROVED
  LOCKED
}

enum AllocationType {
  PROJECT
  RUN
  SUPPORT
}

enum DomainComplexity {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum FamiliaritySource {
  MANUAL
  ALLOCATION_HISTORY
  IMPORT
}

enum ScenarioType {
  BASELINE
  REVISION
  WHAT_IF
}

enum RevisionReason {
  CRITICAL
  COMPLIANCE
  PRODUCTION_OUTAGE
  EXEC_DIRECTIVE
}

enum DriftAlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
}

enum IntakeRequestStatus {
  DRAFT
  TRIAGE
  ASSESSED
  APPROVED
  CONVERTED
  CLOSED
}

enum InitiativeOrigin {
  INTAKE_CONVERTED
  DIRECT_PM
  LEGACY
}

enum OrgNodeType {
  ROOT
  DIVISION
  DEPARTMENT
  TEAM
  VIRTUAL
}

enum ApprovalScope {
  RESOURCE_ALLOCATION
  INITIATIVE
  SCENARIO
}

enum ApprovalRuleType {
  NODE_MANAGER
  SPECIFIC_PERSON
  ROLE_BASED
  ANCESTOR_MANAGER
  COMMITTEE
  FALLBACK_ADMIN
}

enum CrossBuStrategy {
  COMMON_ANCESTOR
  ALL_BRANCHES
}

enum ApprovalRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  EXPIRED
}

enum ApprovalDecisionType {
  APPROVED
  REJECTED
}

enum ForecastMode {
  SCOPE_BASED
  EMPIRICAL
}

enum PlanningMode {
  LEGACY
  TOKEN
}

// ============================================================================
// User
// ============================================================================

model User {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique
  name         String
  role         UserRole  @default(VIEWER)
  passwordHash String?   @map("password_hash")
  auth0Sub     String?   @unique @map("auth0_sub")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedInitiatives        Initiative[]         @relation("BusinessOwner")
  managedInitiatives      Initiative[]         @relation("ProductOwner")
  ledInitiatives          Initiative[]         @relation("ProductLeader")
  approvals               Approval[]
  refreshTokens           RefreshToken[]
  jiraConnections         JiraConnection[]
  intakeRequestsCreated   IntakeRequest[]      @relation("IntakeRequester")
  intakeRequestsSponsored IntakeRequest[]      @relation("IntakeSponsor")
  auditEvents             AuditEvent[]
  approvalRequests        ApprovalRequest[]
  approvalDecisions       ApprovalDecision[]
  delegationsGiven        ApprovalDelegation[] @relation("Delegator")
  delegationsReceived     ApprovalDelegation[] @relation("Delegate")

  @@index([email])
  @@index([role])
}

model RefreshToken {
  id        String    @id @default(uuid()) @db.Uuid
  token     String    @unique @db.VarChar(512)
  userId    String    @map("user_id") @db.Uuid
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================================================
// Period (Time-Bucket Dimension)
// ============================================================================

model Period {
  id        String     @id @default(uuid()) @db.Uuid
  type      PeriodType
  startDate DateTime   @map("start_date") @db.Date
  endDate   DateTime   @map("end_date") @db.Date
  label     String // "2024-Q1", "2024-01", "2024-W01"
  year      Int
  ordinal   Int // Q: 1-4, M: 1-12, W: 1-53

  parentId String?  @map("parent_id") @db.Uuid
  parent   Period?  @relation("PeriodHierarchy", fields: [parentId], references: [id])
  children Period[] @relation("PeriodHierarchy")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations to other models
  targetedInitiatives          Initiative[]
  capacityCalendars            CapacityCalendar[]
  scenarios                    Scenario[]
  allocationPeriods            AllocationPeriod[]
  scopeItemPeriodDistributions ScopeItemPeriodDistribution[]
  activeStartEmployees         Employee[]                    @relation("ActiveStartPeriod")
  activeEndEmployees           Employee[]                    @relation("ActiveEndPeriod")
  freezePolicy                 FreezePolicy?
  driftAlerts                  DriftAlert[]

  @@unique([type, year, ordinal])
  @@index([type])
  @@index([startDate])
  @@index([endDate])
  @@index([parentId])
  @@map("periods")
}

// ============================================================================
// Portfolio Area
// ============================================================================

model PortfolioArea {
  id   String @id @default(uuid()) @db.Uuid
  name String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  initiatives    Initiative[]
  intakeRequests IntakeRequest[]

  @@index([name])
  @@map("portfolio_areas")
}

// ============================================================================
// Initiative & Related
// ============================================================================

model Initiative {
  id               String           @id @default(uuid()) @db.Uuid
  title            String
  description      String?          @db.Text
  businessOwnerId  String           @db.Uuid
  productOwnerId   String           @db.Uuid
  portfolioAreaId  String?          @map("portfolio_area_id") @db.Uuid
  productLeaderId  String?          @map("product_leader_id") @db.Uuid
  status           InitiativeStatus @default(PROPOSED)
  origin           InitiativeOrigin @default(LEGACY)
  targetQuarter    String?
  deliveryHealth   DeliveryHealth?
  targetPeriodId   String?          @map("target_period_id") @db.Uuid
  customFields     Json?            @db.JsonB
  domainComplexity DomainComplexity @default(MEDIUM) @map("domain_complexity")
  orgNodeId        String?          @map("org_node_id") @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessOwner     User                        @relation("BusinessOwner", fields: [businessOwnerId], references: [id])
  productOwner      User                        @relation("ProductOwner", fields: [productOwnerId], references: [id])
  portfolioArea     PortfolioArea?              @relation(fields: [portfolioAreaId], references: [id])
  productLeader     User?                       @relation("ProductLeader", fields: [productLeaderId], references: [id])
  targetPeriod      Period?                     @relation(fields: [targetPeriodId], references: [id])
  orgNode           OrgNode?                    @relation("OrgNodeInitiatives", fields: [orgNodeId], references: [id])
  scopeItems        ScopeItem[]
  approvals         Approval[]
  allocations       Allocation[]
  intakeItems       IntakeItem[]
  intakeRequest     IntakeRequest?
  domainFamiliarity EmployeeDomainFamiliarity[]
  statusLogs        InitiativeStatusLog[]

  @@index([businessOwnerId])
  @@index([productOwnerId])
  @@index([portfolioAreaId])
  @@index([productLeaderId])
  @@index([status])
  @@index([origin])
  @@index([targetQuarter])
  @@index([targetPeriodId])
  @@index([orgNodeId])
}

model ScopeItem {
  id           String  @id @default(uuid()) @db.Uuid
  initiativeId String  @db.Uuid
  name         String
  description  String? @db.Text
  skillDemand  Json?   @db.JsonB // e.g., { "frontend": 2, "backend": 3 }
  estimateP50  Float? // 50th percentile estimate in hours
  estimateP90  Float? // 90th percentile estimate in hours

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  initiative          Initiative                    @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  periodDistributions ScopeItemPeriodDistribution[]

  @@index([initiativeId])
}

model ScopeItemPeriodDistribution {
  scopeItemId  String @map("scope_item_id") @db.Uuid
  periodId     String @map("period_id") @db.Uuid
  distribution Float // 0.0-1.0

  scopeItem ScopeItem @relation(fields: [scopeItemId], references: [id], onDelete: Cascade)
  period    Period    @relation(fields: [periodId], references: [id])

  @@id([scopeItemId, periodId])
  @@index([periodId])
  @@map("scope_item_period_distributions")
}

model Approval {
  id           String   @id @default(uuid()) @db.Uuid
  initiativeId String   @db.Uuid
  approverId   String   @db.Uuid
  version      Int      @default(1)
  notes        String?  @db.Text
  approvedAt   DateTime @default(now())

  // Relations
  initiative Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  approver   User       @relation(fields: [approverId], references: [id])

  @@index([initiativeId])
  @@index([approverId])
  @@index([approvedAt])
}

// ============================================================================
// Employee & Capacity
// ============================================================================

model Employee {
  id                  String         @id @default(uuid()) @db.Uuid
  name                String
  role                String
  managerId           String?        @db.Uuid
  employmentType      EmploymentType @default(FULL_TIME)
  hoursPerWeek        Float          @default(40)
  activeStart         DateTime       @default(now())
  activeEnd           DateTime?
  activeStartPeriodId String?        @map("active_start_period_id") @db.Uuid
  activeEndPeriodId   String?        @map("active_end_period_id") @db.Uuid
  jobProfileId        String?        @map("job_profile_id") @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  manager           Employee?                   @relation("EmployeeManager", fields: [managerId], references: [id])
  directReports     Employee[]                  @relation("EmployeeManager")
  activeStartPeriod Period?                     @relation("ActiveStartPeriod", fields: [activeStartPeriodId], references: [id])
  activeEndPeriod   Period?                     @relation("ActiveEndPeriod", fields: [activeEndPeriodId], references: [id])
  skills            Skill[]
  domains           Domain[]
  capacityCalendar  CapacityCalendar[]
  allocations       Allocation[]
  domainFamiliarity EmployeeDomainFamiliarity[]
  orgMemberships    OrgMembership[]
  managedOrgNodes   OrgNode[]
  jobProfile        JobProfile?                 @relation(fields: [jobProfileId], references: [id])

  @@index([managerId])
  @@index([employmentType])
  @@index([activeStart, activeEnd])
  @@index([jobProfileId])
}

model Skill {
  id          String @id @default(uuid()) @db.Uuid
  name        String
  employeeId  String @db.Uuid
  proficiency Int    @default(3) // 1-5 scale

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, name])
  @@index([name])
  @@index([proficiency])
}

model Domain {
  id          String @id @default(uuid()) @db.Uuid
  name        String
  employeeId  String @db.Uuid
  proficiency Int    @default(3) // 1-5 scale

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, name])
  @@index([name])
  @@index([proficiency])
}

model CapacityCalendar {
  employeeId     String @db.Uuid
  periodId       String @map("period_id") @db.Uuid
  hoursAvailable Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  period   Period   @relation(fields: [periodId], references: [id])

  @@id([employeeId, periodId])
  @@index([periodId])
}

// ============================================================================
// Scenario Planning
// ============================================================================

model Scenario {
  id                   String          @id @default(uuid()) @db.Uuid
  name                 String
  periodId             String          @map("period_id") @db.Uuid
  status               ScenarioStatus  @default(DRAFT)
  isPrimary            Boolean         @default(false) @map("is_primary")
  planLockDate         DateTime?       @map("plan_lock_date")
  assumptions          Json?           @db.JsonB
  priorityRankings     Json?           @db.JsonB
  version              Int             @default(1)
  scenarioType         ScenarioType    @default(WHAT_IF) @map("scenario_type")
  revisionOfScenarioId String?         @map("revision_of_scenario_id") @db.Uuid
  revisionReason       RevisionReason? @map("revision_reason")
  changeLog            String?         @map("change_log") @db.Text
  needsReconciliation  Boolean         @default(false) @map("needs_reconciliation")
  planningMode         PlanningMode    @default(LEGACY) @map("planning_mode")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  period             Period            @relation(fields: [periodId], references: [id])
  allocations        Allocation[]
  revisionOfScenario Scenario?         @relation("ScenarioRevisions", fields: [revisionOfScenarioId], references: [id])
  revisions          Scenario[]        @relation("ScenarioRevisions")
  baselineSnapshot   BaselineSnapshot?
  driftAlerts        DriftAlert[]

  @@index([name])
  @@index([periodId])
  @@index([status])
  @@index([isPrimary])
  @@index([scenarioType])
  @@index([revisionOfScenarioId])
  @@index([planningMode])
}

model Allocation {
  id             String         @id @default(uuid()) @db.Uuid
  scenarioId     String         @db.Uuid
  employeeId     String         @db.Uuid
  initiativeId   String?        @db.Uuid // Nullable for unallocated capacity
  allocationType AllocationType @default(PROJECT) @map("allocation_type")
  startDate      DateTime       @db.Date
  endDate        DateTime       @db.Date
  percentage     Float          @default(100) // Allocation percentage (0-100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  scenario          Scenario           @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  employee          Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  initiative        Initiative?        @relation(fields: [initiativeId], references: [id], onDelete: SetNull)
  allocationPeriods AllocationPeriod[]

  @@index([scenarioId])
  @@index([employeeId])
  @@index([initiativeId])
  @@index([allocationType])
  @@index([startDate, endDate])
}

model AllocationPeriod {
  allocationId  String @map("allocation_id") @db.Uuid
  periodId      String @map("period_id") @db.Uuid
  hoursInPeriod Float  @map("hours_in_period")
  overlapRatio  Float  @map("overlap_ratio") // 0.0-1.0, for debugging
  rampModifier  Float  @default(1.0) @map("ramp_modifier")
  rampBreakdown Json?  @map("ramp_breakdown") @db.JsonB

  allocation Allocation @relation(fields: [allocationId], references: [id], onDelete: Cascade)
  period     Period     @relation(fields: [periodId], references: [id])

  @@id([allocationId, periodId])
  @@index([periodId])
  @@map("allocation_periods")
}

model EmployeeDomainFamiliarity {
  employeeId            String            @map("employee_id") @db.Uuid
  initiativeId          String            @map("initiative_id") @db.Uuid
  familiarityLevel      Float             @default(0.0) @map("familiarity_level")
  source                FamiliaritySource @default(MANUAL)
  lastAllocatedPeriodId String?           @map("last_allocated_period_id") @db.Uuid
  updatedAt             DateTime          @updatedAt @map("updated_at")
  createdAt             DateTime          @default(now()) @map("created_at")

  employee   Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  initiative Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)

  @@id([employeeId, initiativeId])
  @@index([initiativeId])
  @@map("employee_domain_familiarity")
}

// ============================================================================
// Baseline & Drift
// ============================================================================

model BaselineSnapshot {
  id                 String   @id @default(uuid()) @db.Uuid
  scenarioId         String   @unique @map("scenario_id") @db.Uuid
  snapshotDate       DateTime @default(now()) @map("snapshot_date")
  capacitySnapshot   Json     @map("capacity_snapshot") @db.JsonB
  demandSnapshot     Json     @map("demand_snapshot") @db.JsonB
  allocationSnapshot Json     @map("allocation_snapshot") @db.JsonB
  summarySnapshot    Json     @map("summary_snapshot") @db.JsonB
  createdAt          DateTime @default(now()) @map("created_at")

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([scenarioId])
  @@map("baseline_snapshots")
}

model FreezePolicy {
  id               String   @id @default(uuid()) @db.Uuid
  periodId         String   @unique @map("period_id") @db.Uuid
  changeFreezeDate DateTime @map("change_freeze_date")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  period Period @relation(fields: [periodId], references: [id])

  @@map("freeze_policies")
}

model DriftAlert {
  id               String           @id @default(uuid()) @db.Uuid
  scenarioId       String           @map("scenario_id") @db.Uuid
  periodId         String           @map("period_id") @db.Uuid
  status           DriftAlertStatus @default(ACTIVE)
  capacityDriftPct Float            @map("capacity_drift_pct")
  demandDriftPct   Float            @map("demand_drift_pct")
  netGapDrift      Float            @map("net_gap_drift")
  driftDetails     Json             @map("drift_details") @db.JsonB
  detectedAt       DateTime         @default(now()) @map("detected_at")
  acknowledgedAt   DateTime?        @map("acknowledged_at")
  resolvedAt       DateTime?        @map("resolved_at")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  period   Period   @relation(fields: [periodId], references: [id])

  @@index([scenarioId])
  @@index([periodId])
  @@index([status])
  @@map("drift_alerts")
}

model DriftThreshold {
  id                   String   @id @default(uuid()) @db.Uuid
  capacityThresholdPct Float    @default(5.0) @map("capacity_threshold_pct")
  demandThresholdPct   Float    @default(10.0) @map("demand_threshold_pct")
  isGlobal             Boolean  @default(true) @map("is_global")
  periodId             String?  @map("period_id") @db.Uuid
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("drift_thresholds")
}

// ============================================================================
// Jira Integration Enums
// ============================================================================

enum IntakeSourceType {
  JIRA
}

enum IntakeItemStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum SyncRunStatus {
  RUNNING
  COMPLETED
  FAILED
  PARTIAL
}

enum WriteActionType {
  CREATE_SUBTASK
  ADD_COMMENT
  ADD_LINK
}

enum WriteActionStatus {
  PENDING
  SUCCESS
  FAILED
}

// ============================================================================
// Jira Integration Models
// ============================================================================

model JiraConnection {
  id                    String   @id @default(uuid()) @db.Uuid
  userId                String   @map("user_id") @db.Uuid
  atlassianAccountId    String   @unique @map("atlassian_account_id")
  accountEmail          String?  @map("account_email")
  displayName           String?  @map("display_name")
  encryptedAccessToken  String   @map("encrypted_access_token") @db.Text
  encryptedRefreshToken String   @map("encrypted_refresh_token") @db.Text
  tokenExpiresAt        DateTime @map("token_expires_at")
  scopes                String?
  isActive              Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  sites JiraSite[]

  @@index([userId])
  @@map("jira_connections")
}

model JiraSite {
  id               String  @id @default(uuid()) @db.Uuid
  jiraConnectionId String  @map("jira_connection_id") @db.Uuid
  cloudId          String  @map("cloud_id")
  siteName         String  @map("site_name")
  siteUrl          String  @map("site_url")
  isSelected       Boolean @default(false) @map("is_selected")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  jiraConnection    JiraConnection          @relation(fields: [jiraConnectionId], references: [id], onDelete: Cascade)
  projectSelections JiraProjectSelection[]
  intakeItems       IntakeItem[]
  syncCursors       IntegrationSyncCursor[]
  syncRuns          IntegrationSyncRun[]

  @@unique([jiraConnectionId, cloudId])
  @@index([jiraConnectionId])
  @@map("jira_sites")
}

model JiraProjectSelection {
  id          String  @id @default(uuid()) @db.Uuid
  jiraSiteId  String  @map("jira_site_id") @db.Uuid
  projectId   String  @map("project_id")
  projectKey  String  @map("project_key")
  projectName String  @map("project_name")
  isSelected  Boolean @default(true) @map("is_selected")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  jiraSite    JiraSite                @relation(fields: [jiraSiteId], references: [id], onDelete: Cascade)
  syncCursors IntegrationSyncCursor[]

  @@unique([jiraSiteId, projectKey])
  @@index([jiraSiteId])
  @@map("jira_project_selections")
}

model IntakeItem {
  id                 String           @id @default(uuid()) @db.Uuid
  sourceType         IntakeSourceType @default(JIRA) @map("source_type")
  jiraSiteId         String           @map("jira_site_id") @db.Uuid
  jiraIssueId        String           @map("jira_issue_id")
  jiraIssueKey       String           @map("jira_issue_key")
  jiraIssueUrl       String?          @map("jira_issue_url")
  summary            String
  descriptionExcerpt String?          @map("description_excerpt") @db.Text
  issueTypeName      String?          @map("issue_type_name")
  statusName         String?          @map("status_name")
  statusCategory     String?          @map("status_category")
  priorityName       String?          @map("priority_name")
  labels             Json?            @db.JsonB
  assigneeName       String?          @map("assignee_name")
  reporterName       String?          @map("reporter_name")
  jiraCreatedAt      DateTime?        @map("jira_created_at")
  jiraUpdatedAt      DateTime?        @map("jira_updated_at")
  contentHash        String?          @map("content_hash")
  lastSyncedAt       DateTime         @default(now()) @map("last_synced_at")
  lastSeenAt         DateTime         @default(now()) @map("last_seen_at")
  itemStatus         IntakeItemStatus @default(ACTIVE) @map("item_status")

  // Optional link to an initiative
  initiativeId String? @map("initiative_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  jiraSite      JiraSite       @relation(fields: [jiraSiteId], references: [id], onDelete: Cascade)
  initiative    Initiative?    @relation(fields: [initiativeId], references: [id], onDelete: SetNull)
  intakeRequest IntakeRequest?

  @@unique([jiraSiteId, jiraIssueId])
  @@index([jiraSiteId])
  @@index([initiativeId])
  @@index([itemStatus])
  @@index([statusCategory])
  @@index([priorityName])
  @@index([jiraUpdatedAt])
  @@map("intake_items")
}

model IntegrationSyncCursor {
  id                     String   @id @default(uuid()) @db.Uuid
  jiraSiteId             String   @map("jira_site_id") @db.Uuid
  jiraProjectSelectionId String   @map("jira_project_selection_id") @db.Uuid
  lastSyncedAt           DateTime @default(now()) @map("last_synced_at")
  cursorValue            String?  @map("cursor_value")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  jiraSite             JiraSite             @relation(fields: [jiraSiteId], references: [id], onDelete: Cascade)
  jiraProjectSelection JiraProjectSelection @relation(fields: [jiraProjectSelectionId], references: [id], onDelete: Cascade)

  @@unique([jiraSiteId, jiraProjectSelectionId])
  @@index([jiraSiteId])
  @@map("integration_sync_cursors")
}

model IntegrationSyncRun {
  id            String        @id @default(uuid()) @db.Uuid
  jiraSiteId    String        @map("jira_site_id") @db.Uuid
  projectKey    String?       @map("project_key")
  status        SyncRunStatus @default(RUNNING)
  startedAt     DateTime      @default(now()) @map("started_at")
  completedAt   DateTime?     @map("completed_at")
  issuesFound   Int           @default(0) @map("issues_found")
  issuesCreated Int           @default(0) @map("issues_created")
  issuesUpdated Int           @default(0) @map("issues_updated")
  issuesSkipped Int           @default(0) @map("issues_skipped")
  errorMessage  String?       @map("error_message") @db.Text
  triggeredBy   String?       @map("triggered_by")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  jiraSite JiraSite @relation(fields: [jiraSiteId], references: [id], onDelete: Cascade)

  @@index([jiraSiteId])
  @@index([status])
  @@index([startedAt])
  @@map("integration_sync_runs")
}

model IntegrationWriteActionLog {
  id              String            @id @default(uuid()) @db.Uuid
  intakeItemId    String            @map("intake_item_id") @db.Uuid
  actionType      WriteActionType   @map("action_type")
  status          WriteActionStatus @default(PENDING)
  idempotencyKey  String            @unique @map("idempotency_key")
  requestPayload  Json?             @map("request_payload") @db.JsonB
  responsePayload Json?             @map("response_payload") @db.JsonB
  errorMessage    String?           @map("error_message") @db.Text
  createdJiraKey  String?           @map("created_jira_key")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([intakeItemId])
  @@index([status])
  @@map("integration_write_action_logs")
}

// ============================================================================
// Intake Request (Upstream Funnel Workflow)
// ============================================================================

model IntakeRequest {
  id          String              @id @default(uuid()) @db.Uuid
  title       String              @db.VarChar(500)
  description String?             @db.Text
  status      IntakeRequestStatus @default(DRAFT)

  // Requester & Sponsor
  requestedById String? @map("requested_by_id") @db.Uuid
  requestedBy   User?   @relation("IntakeRequester", fields: [requestedById], references: [id])
  sponsorId     String? @map("sponsor_id") @db.Uuid
  sponsor       User?   @relation("IntakeSponsor", fields: [sponsorId], references: [id])

  // Classification
  portfolioAreaId String?        @map("portfolio_area_id") @db.Uuid
  portfolioArea   PortfolioArea? @relation(fields: [portfolioAreaId], references: [id])
  orgNodeId       String?        @map("org_node_id") @db.Uuid
  orgNode         OrgNode?       @relation("OrgNodeIntakeRequests", fields: [orgNodeId], references: [id])
  targetQuarter   String?        @db.VarChar(10)
  valueScore      Int?           @map("value_score")
  effortEstimate  String?        @map("effort_estimate") @db.VarChar(10)
  urgency         String?        @db.VarChar(20)
  customerName    String?        @map("customer_name") @db.VarChar(255)
  tags            Json?          @db.JsonB
  strategicThemes Json?          @map("strategic_themes") @db.JsonB

  // Source linkage (optional - from Jira or other)
  sourceType   IntakeSourceType? @map("source_type")
  intakeItemId String?           @unique @map("intake_item_id") @db.Uuid
  intakeItem   IntakeItem?       @relation(fields: [intakeItemId], references: [id])

  // Conversion linkage
  initiativeId       String?     @unique @map("initiative_id") @db.Uuid
  initiative         Initiative? @relation(fields: [initiativeId], references: [id])
  conversionSnapshot Json?       @map("conversion_snapshot") @db.JsonB

  // Decision log
  decisionNotes String? @map("decision_notes") @db.Text
  closedReason  String? @map("closed_reason") @db.VarChar(50)

  // Audit
  createdBy String?  @map("created_by") @db.Uuid
  updatedBy String?  @map("updated_by") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([portfolioAreaId])
  @@index([orgNodeId])
  @@index([targetQuarter])
  @@index([initiativeId])
  @@index([intakeItemId])
  @@index([requestedById])
  @@index([sponsorId])
  @@map("intake_requests")
}

// ============================================================================
// Org Tree
// ============================================================================

model OrgNode {
  id               String      @id @default(uuid()) @db.Uuid
  name             String
  code             String      @unique
  type             OrgNodeType
  parentId         String?     @db.Uuid
  path             String
  depth            Int         @default(0)
  managerId        String?     @db.Uuid
  sortOrder        Int         @default(0)
  isActive         Boolean     @default(true)
  isPortfolioArea  Boolean     @default(false) @map("is_portfolio_area")
  metadata         Json?       @db.JsonB

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  parent              OrgNode?             @relation("OrgNodeTree", fields: [parentId], references: [id])
  children            OrgNode[]            @relation("OrgNodeTree")
  manager             Employee?            @relation(fields: [managerId], references: [id])
  memberships         OrgMembership[]
  approvalPolicies    ApprovalPolicy[]
  approvalDelegations ApprovalDelegation[]
  initiatives         Initiative[]         @relation("OrgNodeInitiatives")
  intakeRequests      IntakeRequest[]      @relation("OrgNodeIntakeRequests")

  @@index([parentId])
  @@index([type])
  @@index([managerId])
  @@index([isActive])
  @@index([isPortfolioArea])
}

model OrgMembership {
  id             String    @id @default(uuid()) @db.Uuid
  employeeId     String    @db.Uuid
  orgNodeId      String    @db.Uuid
  effectiveStart DateTime  @default(now())
  effectiveEnd   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  orgNode  OrgNode  @relation(fields: [orgNodeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([orgNodeId])
  @@index([effectiveEnd])
}

// ============================================================================
// Audit
// ============================================================================

model AuditEvent {
  id         String  @id @default(uuid()) @db.Uuid
  actorId    String? @db.Uuid
  entityType String
  entityId   String
  action     String
  payload    Json    @db.JsonB
  ipAddress  String?

  createdAt DateTime @default(now())

  // Relations
  actor User? @relation(fields: [actorId], references: [id])

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([action])
  @@index([createdAt])
}

// ============================================================================
// Approval Policies & Workflow
// ============================================================================

model ApprovalPolicy {
  id              String           @id @default(uuid()) @db.Uuid
  orgNodeId       String           @db.Uuid
  scope           ApprovalScope
  level           Int
  ruleType        ApprovalRuleType
  ruleConfig      Json             @default("{}") @db.JsonB
  crossBuStrategy CrossBuStrategy  @default(COMMON_ANCESTOR)
  isActive        Boolean          @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orgNode OrgNode @relation(fields: [orgNodeId], references: [id], onDelete: Cascade)

  @@index([orgNodeId])
  @@index([scope])
  @@index([isActive])
}

model ApprovalRequest {
  id              String                @id @default(uuid()) @db.Uuid
  scope           ApprovalScope
  subjectType     String
  subjectId       String
  requesterId     String                @db.Uuid
  status          ApprovalRequestStatus @default(PENDING)
  snapshotChain   Json                  @db.JsonB
  snapshotContext Json                  @default("{}") @db.JsonB
  currentLevel    Int
  resolvedAt      DateTime?
  expiresAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  requester User               @relation(fields: [requesterId], references: [id])
  decisions ApprovalDecision[]

  @@index([scope])
  @@index([status])
  @@index([requesterId])
  @@index([subjectType, subjectId])
}

model ApprovalDecision {
  id        String               @id @default(uuid()) @db.Uuid
  requestId String               @db.Uuid
  level     Int
  deciderId String               @db.Uuid
  decision  ApprovalDecisionType
  comments  String?              @db.Text

  decidedAt DateTime @default(now())
  createdAt DateTime @default(now())

  // Relations
  request ApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  decider User            @relation(fields: [deciderId], references: [id])

  @@index([requestId])
  @@index([deciderId])
}

model ApprovalDelegation {
  id             String         @id @default(uuid()) @db.Uuid
  delegatorId    String         @db.Uuid
  delegateId     String         @db.Uuid
  scope          ApprovalScope?
  orgNodeId      String?        @db.Uuid
  effectiveStart DateTime
  effectiveEnd   DateTime
  reason         String?        @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  delegator User     @relation("Delegator", fields: [delegatorId], references: [id])
  delegate  User     @relation("Delegate", fields: [delegateId], references: [id])
  orgNode   OrgNode? @relation(fields: [orgNodeId], references: [id])

  @@index([delegatorId])
  @@index([delegateId])
  @@index([effectiveStart, effectiveEnd])
}

// ============================================================================
// Feature Flags
// ============================================================================

model FeatureFlag {
  id          String  @id @default(uuid()) @db.Uuid
  key         String  @unique
  enabled     Boolean @default(false)
  description String? @db.Text
  metadata    Json?   @db.JsonB

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("feature_flags")
}

// ============================================================================
// Job Profiles & Cost Bands
// ============================================================================

model JobProfile {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique
  level       String?
  band        String?
  description String? @db.Text
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  skills    JobProfileSkill[]
  costBand  CostBand?
  employees Employee[]

  @@map("job_profiles")
}

model JobProfileSkill {
  id                  String @id @default(uuid()) @db.Uuid
  jobProfileId        String @map("job_profile_id") @db.Uuid
  skillName           String @map("skill_name")
  expectedProficiency Int    @default(3) @map("expected_proficiency")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  jobProfile JobProfile @relation(fields: [jobProfileId], references: [id], onDelete: Cascade)

  @@unique([jobProfileId, skillName])
  @@index([jobProfileId])
  @@map("job_profile_skills")
}

model CostBand {
  id            String   @id @default(uuid()) @db.Uuid
  jobProfileId  String   @unique @map("job_profile_id") @db.Uuid
  annualCostMin Float?   @map("annual_cost_min")
  annualCostMax Float?   @map("annual_cost_max")
  hourlyRate    Float?   @map("hourly_rate")
  currency      String   @default("USD")
  effectiveDate DateTime @map("effective_date") @db.Date

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  jobProfile JobProfile @relation(fields: [jobProfileId], references: [id], onDelete: Cascade)

  @@index([jobProfileId])
  @@map("cost_bands")
}

// ============================================================================
// Forecasting
// ============================================================================

model ForecastRun {
  id               String       @id @default(uuid()) @db.Uuid
  mode             ForecastMode
  scenarioId       String?      @map("scenario_id") @db.Uuid
  orgNodeId        String?      @map("org_node_id") @db.Uuid
  initiativeIds    Json         @map("initiative_ids") @db.JsonB
  simulationCount  Int          @default(1000) @map("simulation_count")
  confidenceLevels Json         @map("confidence_levels") @db.JsonB
  inputSnapshot    Json         @map("input_snapshot") @db.JsonB
  results          Json         @db.JsonB
  warnings         Json?        @db.JsonB
  dataQuality      Json?        @map("data_quality") @db.JsonB
  computedAt       DateTime     @default(now()) @map("computed_at")
  durationMs       Int?         @map("duration_ms")

  createdAt DateTime @default(now())

  @@index([scenarioId])
  @@index([mode])
  @@map("forecast_runs")
}

// ============================================================================
// Initiative Status Log
// ============================================================================

model InitiativeStatusLog {
  id             String           @id @default(uuid()) @db.Uuid
  initiativeId   String           @map("initiative_id") @db.Uuid
  fromStatus     InitiativeStatus @map("from_status")
  toStatus       InitiativeStatus @map("to_status")
  transitionedAt DateTime         @default(now()) @map("transitioned_at")
  actorId        String?          @map("actor_id") @db.Uuid

  // Relations
  initiative Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)

  @@index([initiativeId])
  @@index([toStatus])
  @@map("initiative_status_logs")
}

// ============================================================================
// Token Planning (Skill Pools & Token Ledger)
// ============================================================================

model SkillPool {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique
  description String? @db.Text
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tokenSupplies     TokenSupply[]
  tokenDemands      TokenDemand[]
  tokenCalibrations TokenCalibration[]

  @@index([name])
  @@index([isActive])
  @@map("skill_pools")
}

model TokenSupply {
  id          String  @id @default(uuid()) @db.Uuid
  scenarioId  String  @map("scenario_id") @db.Uuid
  skillPoolId String  @map("skill_pool_id") @db.Uuid
  tokens      Float
  notes       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  skillPool SkillPool @relation(fields: [skillPoolId], references: [id], onDelete: Cascade)

  @@unique([scenarioId, skillPoolId])
  @@index([scenarioId])
  @@index([skillPoolId])
  @@map("token_supplies")
}

model TokenDemand {
  id           String  @id @default(uuid()) @db.Uuid
  scenarioId   String  @map("scenario_id") @db.Uuid
  initiativeId String  @map("initiative_id") @db.Uuid
  skillPoolId  String  @map("skill_pool_id") @db.Uuid
  tokensP50    Float   @map("tokens_p50")
  tokensP90    Float?  @map("tokens_p90")
  notes        String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  skillPool SkillPool @relation(fields: [skillPoolId], references: [id], onDelete: Cascade)

  @@unique([scenarioId, initiativeId, skillPoolId])
  @@index([scenarioId])
  @@index([initiativeId])
  @@index([skillPoolId])
  @@map("token_demands")
}

model TokenCalibration {
  id            String   @id @default(uuid()) @db.Uuid
  skillPoolId   String   @map("skill_pool_id") @db.Uuid
  tokenPerHour  Float    @default(1.0) @map("token_per_hour")
  effectiveDate DateTime @map("effective_date") @db.Date
  notes         String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  skillPool SkillPool @relation(fields: [skillPoolId], references: [id], onDelete: Cascade)

  @@unique([skillPoolId, effectiveDate])
  @@index([skillPoolId])
  @@map("token_calibrations")
}
