generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Enums
// ============================================================================

enum InitiativeStatus {
  PROPOSED
  SCOPING
  RESOURCING
  IN_EXECUTION
  COMPLETE
  ON_HOLD
  CANCELLED
}

enum DeliveryHealth {
  ON_TRACK
  AT_RISK
  DELAYED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN
}

enum UserRole {
  ADMIN
  PRODUCT_OWNER
  BUSINESS_OWNER
  RESOURCE_MANAGER
  VIEWER
}

enum PeriodType {
  WEEK
  MONTH
  QUARTER
}

enum ScenarioStatus {
  DRAFT
  REVIEW
  APPROVED
  LOCKED
}

// ============================================================================
// User
// ============================================================================

model User {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique
  name         String
  role         UserRole  @default(VIEWER)
  passwordHash String    @map("password_hash")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedInitiatives   Initiative[]   @relation("BusinessOwner")
  managedInitiatives Initiative[]   @relation("ProductOwner")
  approvals          Approval[]
  refreshTokens      RefreshToken[]

  @@index([email])
  @@index([role])
}

model RefreshToken {
  id        String    @id @default(uuid()) @db.Uuid
  token     String    @unique @db.VarChar(512)
  userId    String    @db.Uuid @map("user_id")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================================================
// Period (Time-Bucket Dimension)
// ============================================================================

model Period {
  id        String     @id @default(uuid()) @db.Uuid
  type      PeriodType
  startDate DateTime   @db.Date @map("start_date")
  endDate   DateTime   @db.Date @map("end_date")
  label     String     // "2024-Q1", "2024-01", "2024-W01"
  year      Int
  ordinal   Int        // Q: 1-4, M: 1-12, W: 1-53

  parentId  String?    @db.Uuid @map("parent_id")
  parent    Period?    @relation("PeriodHierarchy", fields: [parentId], references: [id])
  children  Period[]   @relation("PeriodHierarchy")

  createdAt DateTime   @default(now()) @map("created_at")

  // Relations to other models
  targetedInitiatives            Initiative[]
  capacityCalendars              CapacityCalendar[]
  scenarios                      Scenario[]
  allocationPeriods              AllocationPeriod[]
  scopeItemPeriodDistributions   ScopeItemPeriodDistribution[]
  activeStartEmployees           Employee[] @relation("ActiveStartPeriod")
  activeEndEmployees             Employee[] @relation("ActiveEndPeriod")

  @@unique([type, year, ordinal])
  @@index([type])
  @@index([startDate])
  @@index([endDate])
  @@index([parentId])
  @@map("periods")
}

// ============================================================================
// Initiative & Related
// ============================================================================

model Initiative {
  id              String           @id @default(uuid()) @db.Uuid
  title           String
  description     String?          @db.Text
  businessOwnerId String           @db.Uuid
  productOwnerId  String           @db.Uuid
  status          InitiativeStatus @default(PROPOSED)
  targetQuarter   String?
  deliveryHealth  DeliveryHealth?
  targetPeriodId  String?          @db.Uuid @map("target_period_id")
  customFields    Json?            @db.JsonB

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessOwner User        @relation("BusinessOwner", fields: [businessOwnerId], references: [id])
  productOwner  User        @relation("ProductOwner", fields: [productOwnerId], references: [id])
  targetPeriod  Period?     @relation(fields: [targetPeriodId], references: [id])
  scopeItems    ScopeItem[]
  approvals     Approval[]
  allocations   Allocation[]

  @@index([businessOwnerId])
  @@index([productOwnerId])
  @@index([status])
  @@index([targetQuarter])
  @@index([targetPeriodId])
}

model ScopeItem {
  id                  String @id @default(uuid()) @db.Uuid
  initiativeId        String @db.Uuid
  name                String
  description         String? @db.Text
  skillDemand         Json?  @db.JsonB // e.g., { "frontend": 2, "backend": 3 }
  estimateP50         Float? // 50th percentile estimate in hours
  estimateP90         Float? // 90th percentile estimate in hours

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  initiative          Initiative                    @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  periodDistributions ScopeItemPeriodDistribution[]

  @@index([initiativeId])
}

model ScopeItemPeriodDistribution {
  scopeItemId  String @db.Uuid @map("scope_item_id")
  periodId     String @db.Uuid @map("period_id")
  distribution Float  // 0.0-1.0

  scopeItem    ScopeItem @relation(fields: [scopeItemId], references: [id], onDelete: Cascade)
  period       Period    @relation(fields: [periodId], references: [id])

  @@id([scopeItemId, periodId])
  @@index([periodId])
  @@map("scope_item_period_distributions")
}

model Approval {
  id           String   @id @default(uuid()) @db.Uuid
  initiativeId String   @db.Uuid
  approverId   String   @db.Uuid
  version      Int      @default(1)
  notes        String?  @db.Text
  approvedAt   DateTime @default(now())

  // Relations
  initiative Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  approver   User       @relation(fields: [approverId], references: [id])

  @@index([initiativeId])
  @@index([approverId])
  @@index([approvedAt])
}

// ============================================================================
// Employee & Capacity
// ============================================================================

model Employee {
  id                   String         @id @default(uuid()) @db.Uuid
  name                 String
  role                 String
  managerId            String?        @db.Uuid
  employmentType       EmploymentType @default(FULL_TIME)
  hoursPerWeek         Float          @default(40)
  activeStart          DateTime       @default(now())
  activeEnd            DateTime?
  activeStartPeriodId  String?        @db.Uuid @map("active_start_period_id")
  activeEndPeriodId    String?        @db.Uuid @map("active_end_period_id")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  manager            Employee?          @relation("EmployeeManager", fields: [managerId], references: [id])
  directReports      Employee[]         @relation("EmployeeManager")
  activeStartPeriod  Period?            @relation("ActiveStartPeriod", fields: [activeStartPeriodId], references: [id])
  activeEndPeriod    Period?            @relation("ActiveEndPeriod", fields: [activeEndPeriodId], references: [id])
  skills             Skill[]
  capacityCalendar   CapacityCalendar[]
  allocations        Allocation[]

  @@index([managerId])
  @@index([employmentType])
  @@index([activeStart, activeEnd])
}

model Skill {
  id          String @id @default(uuid()) @db.Uuid
  name        String
  employeeId  String @db.Uuid
  proficiency Int    @default(3) // 1-5 scale

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, name])
  @@index([name])
  @@index([proficiency])
}

model CapacityCalendar {
  employeeId     String @db.Uuid
  periodId       String @db.Uuid @map("period_id")
  hoursAvailable Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  period   Period   @relation(fields: [periodId], references: [id])

  @@id([employeeId, periodId])
  @@index([periodId])
}

// ============================================================================
// Scenario Planning
// ============================================================================

model Scenario {
  id               String         @id @default(uuid()) @db.Uuid
  name             String
  periodId         String         @db.Uuid @map("period_id")
  status           ScenarioStatus @default(DRAFT)
  planLockDate     DateTime?      @map("plan_lock_date")
  assumptions      Json?          @db.JsonB // Flexible assumptions storage
  priorityRankings Json?          @db.JsonB // e.g., [{ "initiativeId": "...", "rank": 1 }]
  version          Int            @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  period      Period       @relation(fields: [periodId], references: [id])
  allocations Allocation[]

  @@index([name])
  @@index([periodId])
  @@index([status])
}

model Allocation {
  id           String   @id @default(uuid()) @db.Uuid
  scenarioId   String   @db.Uuid
  employeeId   String   @db.Uuid
  initiativeId String?  @db.Uuid // Nullable for unallocated capacity
  startDate    DateTime @db.Date
  endDate      DateTime @db.Date
  percentage   Float    @default(100) // Allocation percentage (0-100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  scenario          Scenario           @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  employee          Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  initiative        Initiative?        @relation(fields: [initiativeId], references: [id], onDelete: SetNull)
  allocationPeriods AllocationPeriod[]

  @@index([scenarioId])
  @@index([employeeId])
  @@index([initiativeId])
  @@index([startDate, endDate])
}

model AllocationPeriod {
  allocationId  String @db.Uuid @map("allocation_id")
  periodId      String @db.Uuid @map("period_id")
  hoursInPeriod Float  @map("hours_in_period")
  overlapRatio  Float  @map("overlap_ratio") // 0.0-1.0, for debugging

  allocation    Allocation @relation(fields: [allocationId], references: [id], onDelete: Cascade)
  period        Period     @relation(fields: [periodId], references: [id])

  @@id([allocationId, periodId])
  @@index([periodId])
  @@map("allocation_periods")
}
