generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Enums
// ============================================================================

enum InitiativeStatus {
  PROPOSED
  SCOPING
  RESOURCING
  IN_EXECUTION
  COMPLETE
  ON_HOLD
  CANCELLED
}

enum DeliveryHealth {
  ON_TRACK
  AT_RISK
  DELAYED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN
}

enum UserRole {
  ADMIN
  PRODUCT_OWNER
  BUSINESS_OWNER
  RESOURCE_MANAGER
  VIEWER
}

enum PeriodType {
  WEEK
  MONTH
  QUARTER
}

enum ScenarioStatus {
  DRAFT
  REVIEW
  APPROVED
  LOCKED
}

enum AllocationType {
  PROJECT
  RUN
  SUPPORT
}

enum ScenarioType {
  BASELINE
  REVISION
  WHAT_IF
}

enum RevisionReason {
  CRITICAL
  COMPLIANCE
  PRODUCTION_OUTAGE
  EXEC_DIRECTIVE
}

enum DriftAlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
}

// ============================================================================
// User
// ============================================================================

model User {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique
  name         String
  role         UserRole  @default(VIEWER)
  passwordHash String    @map("password_hash")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedInitiatives   Initiative[]     @relation("BusinessOwner")
  managedInitiatives Initiative[]     @relation("ProductOwner")
  ledInitiatives     Initiative[]     @relation("ProductLeader")
  approvals          Approval[]
  refreshTokens      RefreshToken[]
  jiraConnections    JiraConnection[]

  @@index([email])
  @@index([role])
}

model RefreshToken {
  id        String    @id @default(uuid()) @db.Uuid
  token     String    @unique @db.VarChar(512)
  userId    String    @db.Uuid @map("user_id")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================================================
// Period (Time-Bucket Dimension)
// ============================================================================

model Period {
  id        String     @id @default(uuid()) @db.Uuid
  type      PeriodType
  startDate DateTime   @db.Date @map("start_date")
  endDate   DateTime   @db.Date @map("end_date")
  label     String     // "2024-Q1", "2024-01", "2024-W01"
  year      Int
  ordinal   Int        // Q: 1-4, M: 1-12, W: 1-53

  parentId  String?    @db.Uuid @map("parent_id")
  parent    Period?    @relation("PeriodHierarchy", fields: [parentId], references: [id])
  children  Period[]   @relation("PeriodHierarchy")

  createdAt DateTime   @default(now()) @map("created_at")

  // Relations to other models
  targetedInitiatives            Initiative[]
  capacityCalendars              CapacityCalendar[]
  scenarios                      Scenario[]
  allocationPeriods              AllocationPeriod[]
  scopeItemPeriodDistributions   ScopeItemPeriodDistribution[]
  activeStartEmployees           Employee[] @relation("ActiveStartPeriod")
  activeEndEmployees             Employee[] @relation("ActiveEndPeriod")
  freezePolicy                   FreezePolicy?
  driftAlerts                    DriftAlert[]

  @@unique([type, year, ordinal])
  @@index([type])
  @@index([startDate])
  @@index([endDate])
  @@index([parentId])
  @@map("periods")
}

// ============================================================================
// Portfolio Area
// ============================================================================

model PortfolioArea {
  id   String @id @default(uuid()) @db.Uuid
  name String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  initiatives Initiative[]

  @@index([name])
  @@map("portfolio_areas")
}

// ============================================================================
// Initiative & Related
// ============================================================================

model Initiative {
  id              String           @id @default(uuid()) @db.Uuid
  title           String
  description     String?          @db.Text
  businessOwnerId String           @db.Uuid
  productOwnerId  String           @db.Uuid
  portfolioAreaId String?          @db.Uuid @map("portfolio_area_id")
  productLeaderId String?          @db.Uuid @map("product_leader_id")
  status          InitiativeStatus @default(PROPOSED)
  targetQuarter   String?
  deliveryHealth  DeliveryHealth?
  targetPeriodId  String?          @db.Uuid @map("target_period_id")
  customFields    Json?            @db.JsonB

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessOwner User           @relation("BusinessOwner", fields: [businessOwnerId], references: [id])
  productOwner  User           @relation("ProductOwner", fields: [productOwnerId], references: [id])
  portfolioArea PortfolioArea? @relation(fields: [portfolioAreaId], references: [id])
  productLeader User?          @relation("ProductLeader", fields: [productLeaderId], references: [id])
  targetPeriod  Period?        @relation(fields: [targetPeriodId], references: [id])
  scopeItems    ScopeItem[]
  approvals     Approval[]
  allocations   Allocation[]
  intakeItems   IntakeItem[]

  @@index([businessOwnerId])
  @@index([productOwnerId])
  @@index([portfolioAreaId])
  @@index([productLeaderId])
  @@index([status])
  @@index([targetQuarter])
  @@index([targetPeriodId])
}

model ScopeItem {
  id                  String @id @default(uuid()) @db.Uuid
  initiativeId        String @db.Uuid
  name                String
  description         String? @db.Text
  skillDemand         Json?  @db.JsonB // e.g., { "frontend": 2, "backend": 3 }
  estimateP50         Float? // 50th percentile estimate in hours
  estimateP90         Float? // 90th percentile estimate in hours

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  initiative          Initiative                    @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  periodDistributions ScopeItemPeriodDistribution[]

  @@index([initiativeId])
}

model ScopeItemPeriodDistribution {
  scopeItemId  String @db.Uuid @map("scope_item_id")
  periodId     String @db.Uuid @map("period_id")
  distribution Float  // 0.0-1.0

  scopeItem    ScopeItem @relation(fields: [scopeItemId], references: [id], onDelete: Cascade)
  period       Period    @relation(fields: [periodId], references: [id])

  @@id([scopeItemId, periodId])
  @@index([periodId])
  @@map("scope_item_period_distributions")
}

model Approval {
  id           String   @id @default(uuid()) @db.Uuid
  initiativeId String   @db.Uuid
  approverId   String   @db.Uuid
  version      Int      @default(1)
  notes        String?  @db.Text
  approvedAt   DateTime @default(now())

  // Relations
  initiative Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  approver   User       @relation(fields: [approverId], references: [id])

  @@index([initiativeId])
  @@index([approverId])
  @@index([approvedAt])
}

// ============================================================================
// Employee & Capacity
// ============================================================================

model Employee {
  id                   String         @id @default(uuid()) @db.Uuid
  name                 String
  role                 String
  managerId            String?        @db.Uuid
  employmentType       EmploymentType @default(FULL_TIME)
  hoursPerWeek         Float          @default(40)
  activeStart          DateTime       @default(now())
  activeEnd            DateTime?
  activeStartPeriodId  String?        @db.Uuid @map("active_start_period_id")
  activeEndPeriodId    String?        @db.Uuid @map("active_end_period_id")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  manager            Employee?          @relation("EmployeeManager", fields: [managerId], references: [id])
  directReports      Employee[]         @relation("EmployeeManager")
  activeStartPeriod  Period?            @relation("ActiveStartPeriod", fields: [activeStartPeriodId], references: [id])
  activeEndPeriod    Period?            @relation("ActiveEndPeriod", fields: [activeEndPeriodId], references: [id])
  skills             Skill[]
  domains            Domain[]
  capacityCalendar   CapacityCalendar[]
  allocations        Allocation[]

  @@index([managerId])
  @@index([employmentType])
  @@index([activeStart, activeEnd])
}

model Skill {
  id          String @id @default(uuid()) @db.Uuid
  name        String
  employeeId  String @db.Uuid
  proficiency Int    @default(3) // 1-5 scale

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, name])
  @@index([name])
  @@index([proficiency])
}

model Domain {
  id          String @id @default(uuid()) @db.Uuid
  name        String
  employeeId  String @db.Uuid
  proficiency Int    @default(3) // 1-5 scale

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, name])
  @@index([name])
  @@index([proficiency])
}

model CapacityCalendar {
  employeeId     String @db.Uuid
  periodId       String @db.Uuid @map("period_id")
  hoursAvailable Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  period   Period   @relation(fields: [periodId], references: [id])

  @@id([employeeId, periodId])
  @@index([periodId])
}

// ============================================================================
// Scenario Planning
// ============================================================================

model Scenario {
  id                    String          @id @default(uuid()) @db.Uuid
  name                  String
  periodId              String          @db.Uuid @map("period_id")
  status                ScenarioStatus  @default(DRAFT)
  isPrimary             Boolean         @default(false) @map("is_primary")
  planLockDate          DateTime?       @map("plan_lock_date")
  assumptions           Json?           @db.JsonB
  priorityRankings      Json?           @db.JsonB
  version               Int             @default(1)
  scenarioType          ScenarioType    @default(WHAT_IF) @map("scenario_type")
  revisionOfScenarioId  String?         @db.Uuid @map("revision_of_scenario_id")
  revisionReason        RevisionReason? @map("revision_reason")
  changeLog             String?         @db.Text @map("change_log")
  needsReconciliation   Boolean         @default(false) @map("needs_reconciliation")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  period              Period            @relation(fields: [periodId], references: [id])
  allocations         Allocation[]
  revisionOfScenario  Scenario?         @relation("ScenarioRevisions", fields: [revisionOfScenarioId], references: [id])
  revisions           Scenario[]        @relation("ScenarioRevisions")
  baselineSnapshot    BaselineSnapshot?
  driftAlerts         DriftAlert[]

  @@index([name])
  @@index([periodId])
  @@index([status])
  @@index([isPrimary])
  @@index([scenarioType])
  @@index([revisionOfScenarioId])
}

model Allocation {
  id             String         @id @default(uuid()) @db.Uuid
  scenarioId     String         @db.Uuid
  employeeId     String         @db.Uuid
  initiativeId   String?        @db.Uuid // Nullable for unallocated capacity
  allocationType AllocationType @default(PROJECT) @map("allocation_type")
  startDate      DateTime       @db.Date
  endDate        DateTime       @db.Date
  percentage     Float          @default(100) // Allocation percentage (0-100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  scenario          Scenario           @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  employee          Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  initiative        Initiative?        @relation(fields: [initiativeId], references: [id], onDelete: SetNull)
  allocationPeriods AllocationPeriod[]

  @@index([scenarioId])
  @@index([employeeId])
  @@index([initiativeId])
  @@index([allocationType])
  @@index([startDate, endDate])
}

model AllocationPeriod {
  allocationId  String @db.Uuid @map("allocation_id")
  periodId      String @db.Uuid @map("period_id")
  hoursInPeriod Float  @map("hours_in_period")
  overlapRatio  Float  @map("overlap_ratio") // 0.0-1.0, for debugging

  allocation    Allocation @relation(fields: [allocationId], references: [id], onDelete: Cascade)
  period        Period     @relation(fields: [periodId], references: [id])

  @@id([allocationId, periodId])
  @@index([periodId])
  @@map("allocation_periods")
}

// ============================================================================
// Baseline & Drift
// ============================================================================

model BaselineSnapshot {
  id                 String   @id @default(uuid()) @db.Uuid
  scenarioId         String   @unique @db.Uuid @map("scenario_id")
  snapshotDate       DateTime @default(now()) @map("snapshot_date")
  capacitySnapshot   Json     @db.JsonB @map("capacity_snapshot")
  demandSnapshot     Json     @db.JsonB @map("demand_snapshot")
  allocationSnapshot Json     @db.JsonB @map("allocation_snapshot")
  summarySnapshot    Json     @db.JsonB @map("summary_snapshot")
  createdAt          DateTime @default(now()) @map("created_at")

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([scenarioId])
  @@map("baseline_snapshots")
}

model FreezePolicy {
  id               String   @id @default(uuid()) @db.Uuid
  periodId         String   @unique @db.Uuid @map("period_id")
  changeFreezeDate DateTime @map("change_freeze_date")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  period Period @relation(fields: [periodId], references: [id])

  @@map("freeze_policies")
}

model DriftAlert {
  id               String           @id @default(uuid()) @db.Uuid
  scenarioId       String           @db.Uuid @map("scenario_id")
  periodId         String           @db.Uuid @map("period_id")
  status           DriftAlertStatus @default(ACTIVE)
  capacityDriftPct Float            @map("capacity_drift_pct")
  demandDriftPct   Float            @map("demand_drift_pct")
  netGapDrift      Float            @map("net_gap_drift")
  driftDetails     Json             @db.JsonB @map("drift_details")
  detectedAt       DateTime         @default(now()) @map("detected_at")
  acknowledgedAt   DateTime?        @map("acknowledged_at")
  resolvedAt       DateTime?        @map("resolved_at")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  period   Period   @relation(fields: [periodId], references: [id])

  @@index([scenarioId])
  @@index([periodId])
  @@index([status])
  @@map("drift_alerts")
}

model DriftThreshold {
  id                   String   @id @default(uuid()) @db.Uuid
  capacityThresholdPct Float    @default(5.0) @map("capacity_threshold_pct")
  demandThresholdPct   Float    @default(10.0) @map("demand_threshold_pct")
  isGlobal             Boolean  @default(true) @map("is_global")
  periodId             String?  @db.Uuid @map("period_id")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("drift_thresholds")
}

// ============================================================================
// Jira Integration Enums
// ============================================================================

enum IntakeSourceType {
  JIRA
}

enum IntakeItemStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum SyncRunStatus {
  RUNNING
  COMPLETED
  FAILED
  PARTIAL
}

enum WriteActionType {
  CREATE_SUBTASK
  ADD_COMMENT
  ADD_LINK
}

enum WriteActionStatus {
  PENDING
  SUCCESS
  FAILED
}

// ============================================================================
// Jira Integration Models
// ============================================================================

model JiraConnection {
  id                   String   @id @default(uuid()) @db.Uuid
  userId               String   @db.Uuid @map("user_id")
  atlassianAccountId   String   @unique @map("atlassian_account_id")
  accountEmail         String?  @map("account_email")
  displayName          String?  @map("display_name")
  encryptedAccessToken String   @db.Text @map("encrypted_access_token")
  encryptedRefreshToken String  @db.Text @map("encrypted_refresh_token")
  tokenExpiresAt       DateTime @map("token_expires_at")
  scopes               String?
  isActive             Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  sites JiraSite[]

  @@index([userId])
  @@map("jira_connections")
}

model JiraSite {
  id               String  @id @default(uuid()) @db.Uuid
  jiraConnectionId String  @db.Uuid @map("jira_connection_id")
  cloudId          String  @map("cloud_id")
  siteName         String  @map("site_name")
  siteUrl          String  @map("site_url")
  isSelected       Boolean @default(false) @map("is_selected")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  jiraConnection    JiraConnection          @relation(fields: [jiraConnectionId], references: [id], onDelete: Cascade)
  projectSelections JiraProjectSelection[]
  intakeItems       IntakeItem[]
  syncCursors       IntegrationSyncCursor[]
  syncRuns          IntegrationSyncRun[]

  @@unique([jiraConnectionId, cloudId])
  @@index([jiraConnectionId])
  @@map("jira_sites")
}

model JiraProjectSelection {
  id          String  @id @default(uuid()) @db.Uuid
  jiraSiteId  String  @db.Uuid @map("jira_site_id")
  projectId   String  @map("project_id")
  projectKey  String  @map("project_key")
  projectName String  @map("project_name")
  isSelected  Boolean @default(true) @map("is_selected")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  jiraSite    JiraSite                @relation(fields: [jiraSiteId], references: [id], onDelete: Cascade)
  syncCursors IntegrationSyncCursor[]

  @@unique([jiraSiteId, projectKey])
  @@index([jiraSiteId])
  @@map("jira_project_selections")
}

model IntakeItem {
  id                 String           @id @default(uuid()) @db.Uuid
  sourceType         IntakeSourceType @default(JIRA) @map("source_type")
  jiraSiteId         String           @db.Uuid @map("jira_site_id")
  jiraIssueId        String           @map("jira_issue_id")
  jiraIssueKey       String           @map("jira_issue_key")
  jiraIssueUrl       String?          @map("jira_issue_url")
  summary            String
  descriptionExcerpt String?          @db.Text @map("description_excerpt")
  issueTypeName      String?          @map("issue_type_name")
  statusName         String?          @map("status_name")
  statusCategory     String?          @map("status_category")
  priorityName       String?          @map("priority_name")
  labels             Json?            @db.JsonB
  assigneeName       String?          @map("assignee_name")
  reporterName       String?          @map("reporter_name")
  jiraCreatedAt      DateTime?        @map("jira_created_at")
  jiraUpdatedAt      DateTime?        @map("jira_updated_at")
  contentHash        String?          @map("content_hash")
  lastSyncedAt       DateTime         @default(now()) @map("last_synced_at")
  lastSeenAt         DateTime         @default(now()) @map("last_seen_at")
  itemStatus         IntakeItemStatus @default(ACTIVE) @map("item_status")

  // Optional link to an initiative
  initiativeId String? @db.Uuid @map("initiative_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  jiraSite   JiraSite    @relation(fields: [jiraSiteId], references: [id], onDelete: Cascade)
  initiative Initiative? @relation(fields: [initiativeId], references: [id], onDelete: SetNull)

  @@unique([jiraSiteId, jiraIssueId])
  @@index([jiraSiteId])
  @@index([initiativeId])
  @@index([itemStatus])
  @@index([statusCategory])
  @@index([priorityName])
  @@index([jiraUpdatedAt])
  @@map("intake_items")
}

model IntegrationSyncCursor {
  id                      String   @id @default(uuid()) @db.Uuid
  jiraSiteId              String   @db.Uuid @map("jira_site_id")
  jiraProjectSelectionId  String   @db.Uuid @map("jira_project_selection_id")
  lastSyncedAt            DateTime @default(now()) @map("last_synced_at")
  cursorValue             String?  @map("cursor_value")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  jiraSite              JiraSite              @relation(fields: [jiraSiteId], references: [id], onDelete: Cascade)
  jiraProjectSelection  JiraProjectSelection  @relation(fields: [jiraProjectSelectionId], references: [id], onDelete: Cascade)

  @@unique([jiraSiteId, jiraProjectSelectionId])
  @@index([jiraSiteId])
  @@map("integration_sync_cursors")
}

model IntegrationSyncRun {
  id             String        @id @default(uuid()) @db.Uuid
  jiraSiteId     String        @db.Uuid @map("jira_site_id")
  projectKey     String?       @map("project_key")
  status         SyncRunStatus @default(RUNNING)
  startedAt      DateTime      @default(now()) @map("started_at")
  completedAt    DateTime?     @map("completed_at")
  issuesFound    Int           @default(0) @map("issues_found")
  issuesCreated  Int           @default(0) @map("issues_created")
  issuesUpdated  Int           @default(0) @map("issues_updated")
  issuesSkipped  Int           @default(0) @map("issues_skipped")
  errorMessage   String?       @db.Text @map("error_message")
  triggeredBy    String?       @map("triggered_by")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  jiraSite JiraSite @relation(fields: [jiraSiteId], references: [id], onDelete: Cascade)

  @@index([jiraSiteId])
  @@index([status])
  @@index([startedAt])
  @@map("integration_sync_runs")
}

model IntegrationWriteActionLog {
  id              String            @id @default(uuid()) @db.Uuid
  intakeItemId    String            @db.Uuid @map("intake_item_id")
  actionType      WriteActionType   @map("action_type")
  status          WriteActionStatus @default(PENDING)
  idempotencyKey  String            @unique @map("idempotency_key")
  requestPayload  Json?             @db.JsonB @map("request_payload")
  responsePayload Json?             @db.JsonB @map("response_payload")
  errorMessage    String?           @db.Text @map("error_message")
  createdJiraKey  String?           @map("created_jira_key")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([intakeItemId])
  @@index([status])
  @@map("integration_write_action_logs")
}
